<ng-container *ngIf="data$ | async as data">
  <ng-template #addFloorplanBtn>
    <button
      *ngIf="isEdit"
      type="button"
      class="btn btn-warning ml-3"
      (click)="openFloorplanEditor(data)"
    >
      Add floorplan
    </button>
  </ng-template>
  <nav
    [formGroup]="form"
    class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap shadow"
  >
    <a class="navbar-brand" href="javascript: alert('Logo')">Logo</a>
    <button
      (click)="isCollapsed = !isCollapsed"
      class="navbar-toggler"
      type="button"
      aria-controls="navbarSupportedContent"
      [attr.aria-expanded]="isCollapsed"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div [ngbCollapse]="isCollapsed" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item" *ngIf="isEdit">
          <a [routerLink]="['/projects']" class="nav-link">Projects</a>
        </li>
        <li class="nav-item">
          <button
            class="btn btn-success mr-2"
            type="button"
            (click)="takeScreenshot()"
          >
            Take screenshot
          </button>
        </li>
        <li class="nav-item">
          <select
            class="custom-select"
            formControlName="aspectRatio"
            name="aspectRatio"
            (change)="updateCanvasSize()"
          >
            <option *ngFor="let aspect of aspects" [value]="aspect.value">
              {{ aspect.name }}
            </option>
          </select>
        </li>
        <li class="nav-item">
          <input
            *ngIf="form.value.aspectRatio === 'custom'"
            type="number"
            min="0"
            max="2"
            step="0.1"
            class="form-control"
            placeholder="Ratio"
            formControlName="customRatio"
          />
        </li>
      </ul>

      <div class="my-2 my-lg-0">
        <div
          *ngIf="isEdit"
          ngbDropdown
          [autoClose]="false"
          placement="left"
          class="d-inline-block"
        >
          <button class="btn btn-primary" id="dropdownForm1" ngbDropdownToggle>
            Settings
          </button>

          <div
            ngbDropdownMenu
            style="min-width: 280px"
            aria-labelledby="dropdownForm1"
          >
            <form class="px-4 py-3">
              <h3>Defaults</h3>

              <div class="form-group">
                <label>Zoom</label>
                <div class="range-slider">
                  <input
                    class="range-slider__range"
                    (input)="zoomChange()"
                    type="range"
                    formControlName="zoom"
                    step="0"
                    min="30"
                    max="120"
                  />
                  <span class="range-slider__value">
                    <input
                      (change)="zoomChange()"
                      [value]="form.value.zoom"
                      type="number"
                      formControlName="zoom"
                      step="1"
                      min="30"
                      max="120"
                      placeholder="number"
                    />
                  </span>
                </div>
              </div>
              <div class="form-group">
                <label>Default rotation</label>
                <div class="range-slider">
                  <input
                    class="range-slider__range"
                    (input)="rotationYChange()"
                    type="range"
                    formControlName="rotationY"
                    step="0.1"
                    min="0"
                    max="6.3"
                  />
                  <span class="range-slider__value">
                    <input
                      type="number"
                      formControlName="rotationY"
                      (change)="rotationYChange()"
                      [value]="form.value.rotationY"
                      step="0.1"
                      min="0"
                      max="6.3"
                    />
                  </span>
                </div>
              </div>

              <button
                type="button"
                (click)="saveSettings(data.project_id)"
                class="btn btn-success"
              >
                Save defaults
              </button>

              <div class="dropdown-divider"></div>
              <h4>Panorama</h4>

              <div class="form-group">
                <label>Zoom</label>
                <div class="range-slider">
                  <input
                    class="range-slider__range"
                    (input)="panoZoomChange()"
                    type="range"
                    formControlName="panoZoom"
                    step="1"
                    min="30"
                    max="120"
                  />
                  <span class="range-slider__value">
                    <input
                      type="number"
                      formControlName="panoZoom"
                      (change)="panoZoomChange()"
                      [value]="form.value.panoZoom"
                      step="1"
                      min="30"
                      max="120"
                    />
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label>Rotation</label>
                <div class="range-slider">
                  <input
                    class="range-slider__range"
                    (input)="panoCameraStartAngleChange()"
                    type="range"
                    formControlName="panoCameraStartAngle"
                    step="0.1"
                    min="0"
                    max="6.3"
                  />
                  <span class="range-slider__value">
                    <input
                      type="number"
                      formControlName="panoCameraStartAngle"
                      (change)="panoCameraStartAngleChange()"
                      [value]="form.value.panoCameraStartAngle"
                      step="0.1"
                      min="0"
                      max="6.3"
                    />
                  </span>
                </div>
              </div>

              <button
                type="button"
                class="btn btn-success"
                (click)="updatePanoSettings()"
              >
                Save panorama
              </button>
            </form>
          </div>
        </div>

        <div
          class="btn-group"
          ngbDropdown
          role="group"
          aria-label="Button group with nested dropdown"
        >
          <button type="button" class="btn btn-primary ml-3" ngbDropdownToggle>
            Change view
          </button>
          <div class="dropdown-menu text-center" ngbDropdownMenu>
            <div
              class="btn-group btn-group-toggle"
              ngbRadioGroup
              name="radioBasic"
              formControlName="sidebarSide"
            >
              <label ngbButtonLabel class="btn-primary">
                <input ngbButton type="radio" value="l" /> Left
              </label>
              <label ngbButtonLabel class="btn-primary">
                <input ngbButton type="radio" value="r" /> Right
              </label>
            </div>
          </div>
        </div>

        <ng-container *ngTemplateOutlet="addFloorplanBtn"></ng-container>
      </div>
    </div>
  </nav>

  <ng-template #modalWrapper let-modal>
    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">{{ modalTitle }}</h4>
      <button
        type="button"
        class="close"
        aria-label="Close"
        (click)="modal.dismiss('Cross click')"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body" *ngIf="modalContent">
      <ng-container *ngTemplateOutlet="modalContent"></ng-container>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-outline-dark"
        (click)="modal.close('Save click')"
      >
        Close
      </button>
    </div>
  </ng-template>

  <ng-template #floorplanTpl>
    <div
      class="vt-map"
      *ngIf="
        data.additional_data && data.additional_data.floors;
        else addFloorplanBtn
      "
    >
      <ul
        ngbNav
        (navChange)="navFloor($event, data.panoFloors, data.panos)"
        #nav="ngbNav"
        [activeId]="activeFloor"
        class="nav-tabs mb-5"
      >
        <li
          *ngFor="let f of data.additional_data.floors; index as i"
          [ngbNavItem]="f.floor"
        >
          <a ngbNavLink>{{ f.floor }}</a>
          <ng-template ngbNavContent>
            <div class="d-flex justify-content-center">
              <div
                #bound
                class="vt-map-wrapper"
                [style.transform]="'rotate(' + -f.nav_dots_rotation + 'deg)'"
              >
                <img
                  class="vt-map-wrapper-floorplan"
                  #floorplanImage
                  [src]="
                    data.projectFolder +
                    f['floorplan_f' + f.floor + '.svg'] +
                    '?_t=' +
                    data._t
                  "
                  [style.transform]="'rotate(' + f.nav_dots_rotation + 'deg)'"
                />
                <div class="vt-map-ponits-wrapper" [ngStyle]="scaleDots(f)">
                  <ng-container
                    *ngFor="let p of data.panoFloorsCoord[i]; index as n"
                  >
                    <div
                      class="vt-map-point"
                      (click)="activePoint === p.index ? false : navTo(p.index)"
                      [class.active]="activePoint === p.index"
                      [ngStyle]="getStyleForDot(f, p)"
                    >
                      <div class="vt-map-point-order">{{ p.order }}</div>
                      <div
                        *ngIf="activePoint === p.index"
                        class="pointer"
                        [style.transform]="'rotate(' + rotationAngle + 'rad)'"
                      ></div>
                    </div>

                    <ng-template #activePointTpl>
                      <div
                        [className]="'vt-map-point active'"
                        [ngStyle]="getStyleForDot(f, p)"
                      >
                        <div class="vt-map-point-order">{{ p.order }}</div>
                        <div
                          class="pointer"
                          [style.transform]="'rotate(' + rotationAngle + 'rad)'"
                        ></div>
                        <!-- (lon + currentDot.rotation_angle) -->
                      </div>
                    </ng-template>
                  </ng-container>
                </div>
              </div>
            </div>
          </ng-template>
        </li>
      </ul>
      <div class="mb-5" [ngbNavOutlet]="nav"></div>
    </div>
  </ng-template>

  <ng-template #mapTplAgm>
    <agm-map
      [latitude]="+data.project.latitude"
      [longitude]="+data.project.longitude"
      [zoom]="17"
    >
      <agm-marker
        [latitude]="+data.project.latitude"
        [longitude]="+data.project.longitude"
      ></agm-marker>
    </agm-map>
  </ng-template>

  <ng-template #mapTpl>
    <div
      *ngIf="data.project.map.link; else mapTplAgm"
      class="embed-responsive embed-responsive-1by1"
    >
      <iframe
        class="embed-responsive-item"
        [src]="data.project.map.link | safe: 'resourceUrl'"
      ></iframe>
    </div>
  </ng-template>

  <ng-template #streetViewTplNative>
    <div
      propertyspacesGoogleStreetView
      [coords]="{ lat: +data.project.latitude, lng: +data.project.longitude }"
      id="street-view"
    ></div>
  </ng-template>

  <ng-template #streetViewTpl>
    <div
      *ngIf="data.project.tour.link; else streetViewTplNative"
      class="embed-responsive embed-responsive-1by1"
    >
      <iframe
        class="embed-responsive-item"
        [src]="data.project.tour.link | safe: 'resourceUrl'"
      ></iframe>
    </div>
  </ng-template>

  <ng-template #galleryTpl>
    <ngx-masonry
      style="min-height: 100px"
      [options]="masonryOptions"
      [ordered]="true"
      *ngIf="gallery$ | async as images"
    >
      <div
        ngxMasonryItem
        *ngFor="let img of images | gallery; index as i"
        (click)="openImage(i)"
        class="masonry-item"
      >
        <img
          class="img-fluid gallery-img"
          [src]="img.data.src"
          [alt]="img.data.thumb"
        />
      </div>
    </ngx-masonry>
  </ng-template>

  <ng-template #galleryEditorTpl>
    <ng-container *ngIf="gallery$ | async as orderedImages">
      <propertyspaces-gallery-editor
        [items]="orderedImages"
        (nameChange)="imageNameChanged($event, data.project_id)"
        (sortChange)="sortChanged($event, data.project_id)"
        (moveToTrash)="deleteGalleryImage($event, data.project_id)"
      ></propertyspaces-gallery-editor>
    </ng-container>
  </ng-template>

  <ng-template #contactTpl>
    Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry
    richardson ad squid. 3 wolf moon officia aute, non cupidatat skateboard
    dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon
    tempor, sunt aliqua put a bird on it squid single-origin coffee nulla
    assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore
    wes anderson cred nesciunt sapiente ea proident. Ad vegan excepteur butcher
    vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic
    synth nesciunt you probably haven't heard of them accusamus labore
    sustainable VHS.
  </ng-template>

  <main class="panorama-player d-flex">
    <div class="boxes d-flex">
      <div
        class="sidebar"
        #sidebar
        [class.stick-right]="form.value.sidebarSide === 'r'"
        ngResizable
        [rzHandles]="form.value.sidebarSide === 'r' ? 'w' : 'e'"
        (rzResizing)="resizeCanvas()"
        (rzStop)="updateMasonty()"
      >
        <div
          class="close-gallery"
          *ngIf="isGalleryOpened"
          (click)="closeGallery()"
        >
          <i class="fa fa-3x fa-close"></i>
        </div>
        <ngb-accordion
          class="sidebar-accordion"
          #acc="ngbAccordion"
          activeIds="ngb-panel-0"
        >
          <ngb-panel cardClass="sidebar-card">
            <ng-template ngbPanelHeader>
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <button ngbPanelToggle class="btn btn-link p-0">
                  Floor Plan
                </button>
                <button
                  class="btn btn-primary"
                  (click)="
                    openSectionModal(modalWrapper, floorplanTpl, 'Floor Plan')
                  "
                >
                  <i class="fa fa-expand"></i>
                </button>
              </div>
            </ng-template>
            <ng-template ngbPanelContent>
              <ng-container *ngTemplateOutlet="floorplanTpl"></ng-container>
            </ng-template>
          </ngb-panel>

          <ngb-panel
            cardClass="sidebar-card"
            *ngIf="data.additional_data.mapEnabled"
          >
            <ng-template ngbPanelHeader>
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <button ngbPanelToggle class="btn btn-link p-0">Map</button>
                <button
                  class="btn btn-primary"
                  (click)="openSectionModal(modalWrapper, mapTpl, 'Map')"
                >
                  <i class="fa fa-expand"></i>
                </button>
              </div>
            </ng-template>
            <ng-template ngbPanelContent>
              <ng-container *ngTemplateOutlet="mapTpl"></ng-container>
            </ng-template>
          </ngb-panel>

          <ngb-panel
            cardClass="sidebar-card"
            *ngIf="data.additional_data.streetViewEnabled"
          >
            <ng-template ngbPanelHeader>
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <button ngbPanelToggle class="btn btn-link p-0">
                  Street View
                </button>
                <button
                  class="btn btn-primary"
                  (click)="
                    openSectionModal(modalWrapper, streetViewTpl, 'Street View')
                  "
                >
                  <i class="fa fa-expand"></i>
                </button>
              </div>
            </ng-template>
            <ng-template ngbPanelContent>
              <ng-container *ngTemplateOutlet="streetViewTpl"></ng-container>
            </ng-template>
          </ngb-panel>

          <ngb-panel cardClass="sidebar-card">
            <ng-template ngbPanelHeader>
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <button ngbPanelToggle class="btn btn-link p-0">
                  Photo Gallery
                </button>
                <button
                  *ngIf="gallery$ | async as galleryPhotos"
                  class="btn btn-primary"
                  (click)="
                    openSectionModal(
                      modalWrapper,
                      galleryEditorTpl,
                      'Gallery Editor'
                    )
                  "
                >
                  <i class="fa fa-expand"></i>
                </button>
              </div>
            </ng-template>
            <ng-template ngbPanelContent>
              <ng-container *ngTemplateOutlet="galleryTpl"></ng-container>
            </ng-template>
          </ngb-panel>

          <ngb-panel cardClass="sidebar-card">
            <ng-template ngbPanelHeader>
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <button ngbPanelToggle class="btn btn-link p-0">Contact</button>
                <button
                  class="btn btn-primary"
                  (click)="
                    openSectionModal(modalWrapper, contactTpl, 'Contact')
                  "
                >
                  <i class="fa fa-expand"></i>
                </button>
              </div>
            </ng-template>
            <ng-template ngbPanelContent>
              <ng-container *ngTemplateOutlet="contactTpl"></ng-container>
            </ng-template>
          </ngb-panel>
        </ngb-accordion>
      </div>
      <div class="content">
        <ng-container *ngIf="gallery$ | async as galleryItems">
          <gallery
            id="project-gallery"
            [class.d-none]="!isGalleryOpened"
            [items]="galleryItems | gallery"
            [itemTemplate]="itemTemplate"
          ></gallery>
          <ng-template
            #itemTemplate
            let-index="index"
            let-type="type"
            let-data="data"
            let-currIndex="currIndex"
          >
            <span
              *ngIf="type === 'image' && index === currIndex"
              [@slideAnimation]
              class="item-text"
            >
              {{ data?.name }}
            </span>
          </ng-template>
        </ng-container>

        <div
          class="main-scene-wrapper"
          #sceneWrapper
          [style.width]="canvasAspect(sceneWrapper)"
        >
          <canvas
            #virtualTour
            id="virtualTour"
            [propertyspacesVirtualTour]="data"
            (init)="vrInit(data)"
            (navigationChange)="changeActive($event, data.panos)"
            (change)="viewChange($event)"
          ></canvas>
        </div>
      </div>
    </div>
  </main>
</ng-container>
